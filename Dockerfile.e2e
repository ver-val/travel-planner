# ---------- Test build image ----------
FROM node:22-alpine AS test
WORKDIR /app

# Install all dependencies (incl. dev)
COPY package*.json ./
RUN npm ci

# Copy source and configs
COPY tsconfig*.json ./
COPY ormconfig.ts ./
COPY src ./src
COPY migrations ./migrations
COPY test ./test

# Build the app
RUN npm run build

# Environment for tests
ENV NODE_ENV=test

# Default command runs migrations + e2e tests
CMD ["sh", "-c", "npm run typeorm:migration:run && npm run test:e2e"]
